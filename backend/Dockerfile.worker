# Optimized R package installation - uses binaries when possible
FROM rocker/r-ver:4.3.2

ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /app

# Install curl and other essential tools first
RUN apt-get update && apt-get install -y \
    curl \
    gnupg \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install system dependencies required for R package compilation
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    gnupg \
    lsb-release \
    build-essential \
    gfortran \
    libbz2-dev \
    liblzma-dev \
    libpcre2-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    zlib1g-dev \
    libxml2-dev \
    libgit2-dev \
    libfontconfig1-dev \
    libcairo2-dev \
    libharfbuzz-dev \
    libfribidi-dev \
    libfreetype6-dev \
    libpng-dev \
    libtiff5-dev \
    libjpeg-dev \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy package files and install Node dependencies
COPY package*.json ./
RUN npm ci

# Copy application source
COPY . .

# Create optimized startup script - installs packages FAST
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸš€ Starting MicroBRSoil Worker (Optimized)"\n\
echo "R version: $(R --version | head -1)"\n\
echo "Node version: $(node --version)"\n\
\n\
# Check if dada2 is available (core requirement)\n\
if Rscript -e "library(dada2)" 2>/dev/null; then\n\
  echo "âœ… Core packages ready"\n\
else\n\
  echo "ðŸ“¦ Installing R packages (optimized for speed)..."\n\
  \n\
  # Use parallel installation and binary packages when possible\n\
  export R_INSTALL_OPTS="--byte-compile"\n\
  \n\
  echo "Installing BiocManager..."\n\
  if ! Rscript -e "install.packages(\"BiocManager\", repos=\"https://cloud.r-project.org\")"; then\n\
    echo "âŒ Failed to install BiocManager"\n\
    exit 1\n\
  fi\n\
  \n\
  echo "Installing MINIMAL core packages only..."\n\
  # Install ONLY the absolute essentials first - NO PARALLEL to avoid lock conflicts\n\
  if ! Rscript -e "BiocManager::install(\"dada2\", ask=FALSE, update=FALSE)"; then\n\
    echo "âŒ Failed to install dada2"\n\
    exit 1\n\
  fi\n\
  \n\
  if ! Rscript -e "install.packages(\"ggplot2\", repos=\"https://cloud.r-project.org\")"; then\n\
    echo "âŒ Failed to install ggplot2"\n\
    exit 1\n\
  fi\n\
  \n\
  # Verify installation worked\n\
  if ! Rscript -e "library(dada2)"; then\n\
    echo "âŒ dada2 installation verification failed"\n\
    exit 1\n\
  fi\n\
  \n\
  echo "âœ… Core packages installed successfully!"\n\
  echo "ðŸ“ Additional packages will be installed on-demand during first pipeline run"\n\
fi\n\
\n\
echo "ðŸŽ¯ Starting worker process..."\n\
exec "$@"' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["npm", "run", "worker"]
