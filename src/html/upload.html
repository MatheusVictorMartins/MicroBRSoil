<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>microBRsoil</title>
    <!--
    Fala pessoal, o motivo de eu estar utilizando o bootstrap minimal é que eu não vejo muito motivo para utilizar
    a versão mais "robusta" que o bootstrap possui, muito menos toda a pasta de módulos dele, entã optei pelo minimal que
    tira alguns whitespaces, deixa uns comandos mais simples e diminui alguns MBs do projeto, deixando ele mais leve.

    *Um adendo é sobre as versões CDN(CSS e JS) e Locais, onde optei por deixar a local pois caso tenha algum problema de conexão enquanto
    eu ou alguém do grupo estiver mexendo com o front-end no geral, o bootstrap continue funcionando sem problemas. Caso alguém ache melhor
    e tenha algum motivo que seja realmente benéfico utilizar o CDN ao invés do local(que particularmente eu não consigo ver nenhum)
    por favor me avisa que a gente discute e muda isso. Mas creio eu que o local está de bom tamanho e não vejo algum malefício
    em utilizar ele a não ser facilidade de instalação(que é 100% porque não precisa instalar nada :P), mas posso estar errado.
    Mas caso queira utilizar a versão CDN(Tanto CSS quanto JS), ela já está pronta no projeto, basta comentar a versão local e 
    descomentar a versão CDN, mas se for fazer isso por favor avise o grupo antes de fazer isso.

    Ass.: Matheus(non-regular-bootstrapuser-sorry)
    -->

    <!--#region BOOTSTRAP CSS IMPORT-->
    <!--===================================================================================================================================-->
    <!--BOOTSTRAP CDN CSS IMPORT *USE IF YOU NEED IT; **COMMENT THE BOOTSTRAP LOCAL CSS IMPORT BELOW BEFORE USE CDN-->
    <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">-->

    <!--BOOTSTRAP MINIMAL LOCAL CSS IMPORT-->
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <!--===================================================================================================================================-->
    <!--#endregion-->
    
    <!--LOCAL CSS IMPORT-->
    <link rel="stylesheet" href="../static/css/reset.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/css/header.css">
    <link rel="stylesheet" href="../static/css/footer.css">
    <link rel="stylesheet" href="../static/css/left_menu.css">
    <link rel="stylesheet" href="../static/css/upload.css">
    <link rel="stylesheet" href="../static/css/dynamic-content.css">
    <!--FONT IMPORT-->
    <!--INTER-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <!--TIENNE-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tienne:wght@400;700;900&display=swap" rel="stylesheet">
    <!--ICONS IMPORT-->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300" rel="stylesheet" />
  </head>
  
<body>
  <!--HEADER PLACEHOLDER-->
  <div id="header-placeholder"></div>
  
  <!--#region LAYOUT-->
  <div class="layout">
    <!--LEFT MENU PLACEHOLDER-->
    <div id="leftmenu-placeholder"></div>
    <!--#region MAIN -->
    <main class="main-content">
      <div id="home">
      <span id="dashboard">
        <span class="home-title-row">
          <h1 class="main-title">UPLOAD DATA</h1>
        </span>
        <div class="upload-dropdown basic-frame">
          <div class="upload-dropdown-item">
            <label for="upload_select" class="form-label text-input-label">SELECT THE ANALYSIS TYPE</label>
            <select id="upload_select" class="form-select" aria-label="Default select example">
              <option selected disabled>Choose an analysis...</option>
              <option value="illumina">Illumina - FASTQ(.fastq)</option>
              <option value="iontorrent">Iontorrent - BARCODES(.fa) + FASTQ(.fastq)</option>
              <option value="its">ITS - FASTQ(.fastq)</option>
            </select>
          </div>
          
          <!-- Unified Upload Area -->
          <div id="unified-upload-area" class="upload-area-container" style="display: none;">
            <form id="unifiedUploadForm" class="upload-form">
              <div class="upload-inputfile">
                <label class="form-label text-input-label">UPLOAD FILES</label>
                <div class="file-drop-zone" id="fileDropZone">
                  <div class="drop-zone-content">
                    <span class="material-symbols-rounded upload-icon">cloud_upload</span>
                    <h4>Drag and drop files here</h4>
                    <p>or click to browse files</p>
                    <p class="file-types" id="acceptedFileTypes">Accepted file types will be shown here</p>
                  </div>
                  <input class="form-control dropfile-input" type="file" name="files" id="fileInput" multiple required style="display: none;" />
                </div>
                <div class="form-text" id="uploadHelpText">Select files for analysis</div>
              </div>
              
              <div class="selected-files" id="selectedFiles"></div>
              
              <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="progress-text">0%</div>
              </div>
              
              <div class="upload-status" id="uploadStatus"></div>
              
              <button type="submit" class="btn btn-primary upload-btn" id="uploadBtn" disabled>
                <span class="material-symbols-rounded">upload</span>
                Upload Files
              </button>
            </form>
          </div>
        </div>
        <div class="dashboard-table table-responsive basic-frame">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">MATERIAL</th>
                <th scope="col">PROJECT NAME</th>
                <th scope="col">LOCATION</th>
                <th scope="col">CREATION DATE</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">00000</th>
                <td>Water</td>
                <td>Subsurface mine microbial mat metagenome</td>
                <td>Japan</td>
                <td>2015-06-19</td>
              </tr>
              <tr>
                <th scope="row">00001</th>
                <td>Soil; Water</td>
                <td>Rice rhizosphere metagenome</td>
                <td>Japan</td>
                <td>2016-07-25</td>
              </tr>
              <tr class="table-row">
                <th scope="row">00002</th>
                <td>Soil; Water</td>
                <td>Metagenomic analysis of rice shoot-associated bacteria</td>
                <td>United States of America</td>
                <td>2016-07-25</td>
              </tr>
              <tr>
                <th scope="row">00003</th>
                <td>Soil</td>
                <td>Metagenomic analysis of rice shoot-associated bacteria</td>
                <td>United States of America</td>
                <td>2016-10-06</td>
              </tr>
              <tr>
                <th scope="row">00004</th>
                <td>Soil</td>
                <td>Dynamics of the gene pool of soil microbiota disturbed by chemical pollution</td>
                <td>United States of America</td>
                <td>2016-10-06</td>
              </tr>
              <tr>
                <th scope="row">00005</th>
                <td>Water</td>
                <td>Dynamics of the gene pool of soil microbiota disturbed by chemical pollution</td>
                <td>Japan</td>
                <td>2017-03-23</td>
              </tr>
                            <tr>
                <th scope="row">00005</th>
                <td>Water</td>
                <td>Dynamics of the gene pool of soil microbiota disturbed by chemical pollution</td>
                <td>Japan</td>
                <td>2017-03-23</td>
              </tr>
                            <tr>
                <th scope="row">00005</th>
                <td>Water</td>
                <td>Dynamics of the gene pool of soil microbiota disturbed by chemical pollution</td>
                <td>Japan</td>
                <td>2017-03-23</td>
              </tr>
              <tr>
                <th scope="row">00005</th>
                <td>Water</td>
                <td>Dynamics of the gene pool of soil microbiota disturbed by chemical pollution</td>
                <td>Japan</td>
                <td>2017-03-23</td>
              </tr>
                            <tr>
                <th scope="row">00005</th>
                <td>Water</td>
                <td>Dynamics of the gene pool of soil microbiota disturbed by chemical pollution</td>
                <td>Japan</td>
                <td>2017-03-23</td>
              </tr>
              <tr>
                <th scope="row">00005</th>
                <td>Water</td>
                <td>Dynamics of the gene pool of soil microbiota disturbed by chemical pollution</td>
                <td>Japan</td>
                <td>2017-03-23</td>
              </tr>
            </tbody>
          </table>
        </div>
      </span>
    </div>
    </main>
    <!--#endregion-->
  </div>
  <!--#endregion-->


  <!--#region HEADER INCLUDE-->
    <script src="../static/js/include_elements.js"></script>
  <!--#endregion-->
  
  <!--SOIL DATA MANAGER-->
  <script src="../static/js/soil_data_manager.js"></script>
  
  <!--#region BOOTSTRAP JS LINK-->
    <script src="../static/js/button.js"></script>
    <!--===================================================================================================================================-->
    <!--BOOTSTRAP CDN JAVASCRIPT IMPORT *USE IF YOU NEED IT; **COMMENT THE "BOOTSTRAP LOCAL JAVASCRIPT IMPORT" BELOW BEFORE USE CDN-->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    -->

    <!--BOOSTRAP MINIMAL LOCAL JAVASCRIPT IMPORT-->
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <!--===================================================================================================================================-->
  <!--#endregion-->

  <script>
    const analysis_select = document.getElementById("upload_select");
    const uploadArea = document.getElementById("unified-upload-area");
    const fileInput = document.getElementById("fileInput");
    const fileDropZone = document.getElementById("fileDropZone");
    const uploadForm = document.getElementById("unifiedUploadForm");
    const uploadBtn = document.getElementById("uploadBtn");
    const acceptedFileTypes = document.getElementById("acceptedFileTypes");
    const uploadHelpText = document.getElementById("uploadHelpText");

    // Upload state management
    let currentUpload = {
      isUploading: false,
      progress: 0,
      selectedPipeline: null
    };

    // Pipeline configurations
    const pipelineConfigs = {
      illumina: {
        accept: ".fastq,.fq,.fastq.gz,.fa",
        helpText: "Select FASTQ files for Illumina sequencing analysis",
        fileTypes: "FASTQ (.fastq, .fq, .fastq.gz), FASTA (.fa)",
        endpoint: "/upload/illumina"
      },
      iontorrent: {
        accept: ".fastq,.fq,.fastq.gz,.fa",
        helpText: "Select FASTQ and BARCODE files for IonTorrent analysis",
        fileTypes: "FASTQ (.fastq, .fq, .fastq.gz), FASTA (.fa)",
        endpoint: "/upload/iontorrent"
      },
      its: {
        accept: ".fastq,.fq,.fastq.gz,.fa",
        helpText: "Select FASTQ files for ITS analysis",
        fileTypes: "FASTQ (.fastq, .fq, .fastq.gz), FASTA (.fa)",
        endpoint: "/upload/its"
      }
    };

    function handlePipelineSelection() {
      const selectedPipeline = analysis_select.value;
      
      if (!selectedPipeline || selectedPipeline === "Choose an analysis...") {
        uploadArea.style.display = "none";
        currentUpload.selectedPipeline = null;
        return;
      }

      const config = pipelineConfigs[selectedPipeline];
      if (!config) return;

      // Update pipeline selection
      currentUpload.selectedPipeline = selectedPipeline;
      
      // Update UI elements
      fileInput.accept = config.accept;
      acceptedFileTypes.textContent = config.fileTypes;
      uploadHelpText.textContent = config.helpText;
      uploadBtn.innerHTML = `<span class="material-symbols-rounded">upload</span> Upload ${selectedPipeline.toUpperCase()}`;
      
      // Show upload area
      uploadArea.style.display = "block";
      
      // Reset form
      resetForm();
    }

    function resetForm() {
      fileInput.value = "";
      document.getElementById("selectedFiles").innerHTML = "";
      uploadBtn.disabled = true;
      showStatus("", "");
      showProgress(false);
    }

    // Drag and drop functionality
    function initializeDragAndDrop() {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileDropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        fileDropZone.addEventListener(eventName, () => {
          fileDropZone.classList.add('drag-active');
        }, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        fileDropZone.addEventListener(eventName, () => {
          fileDropZone.classList.remove('drag-active');
        }, false);
      });

      fileDropZone.addEventListener('drop', handleDrop, false);
      fileDropZone.addEventListener('click', () => fileInput.click());
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      // Update file input with dropped files
      fileInput.files = files;
      handleFileSelection();
    }

    function handleFileSelection() {
      const files = fileInput.files;
      
      if (files.length === 0) {
        uploadBtn.disabled = true;
        document.getElementById("selectedFiles").innerHTML = "";
        return;
      }

      uploadBtn.disabled = false;
      displaySelectedFiles(files);
    }

    function displaySelectedFiles(files) {
      const selectedFilesDiv = document.getElementById('selectedFiles');
      
      if (files.length === 0) {
        selectedFilesDiv.innerHTML = '';
        return;
      }
      
      let html = '<div class="mt-3"><strong>Selected Files:</strong><ul class="list-group mt-2">';
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const size = formatFileSize(file.size);
        const icon = getFileIcon(file.name);
        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                   <span><span class="material-symbols-rounded file-icon">${icon}</span> ${file.name}</span>
                   <span class="badge bg-secondary">${size}</span>
                 </li>`;
      }
      
      html += '</ul></div>';
      selectedFilesDiv.innerHTML = html;
    }

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      switch(ext) {
        case 'fastq':
        case 'fq':
          return 'description';
        case 'gz':
          return 'folder_zip';
        case 'fa':
        case 'fasta':
          return 'code';
        default:
          return 'insert_drive_file';
      }
    }

    // Upload handler function
    async function handleUpload(event) {
      event.preventDefault();
      
      if (currentUpload.isUploading || !currentUpload.selectedPipeline) return;

      const files = fileInput.files;

      if (!files || files.length === 0) {
        showStatus('Please select at least one file', 'error');
        return;
      }

      const formData = new FormData();
      
      // Add all files to FormData
      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }

      const config = pipelineConfigs[currentUpload.selectedPipeline];
      if (!config) {
        showStatus('Invalid analysis type', 'error');
        return;
      }

      try {
        currentUpload.isUploading = true;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';

        showProgress(true);
        showStatus(`Starting upload of ${files.length} file(s)...`, 'info');

        // Create XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();
        
        // Progress tracking
        xhr.upload.addEventListener('progress', (event) => {
          if (event.lengthComputable) {
            const percentComplete = (event.loaded / event.total) * 100;
            updateProgress(percentComplete);
          }
        });

        // Upload completion
        xhr.addEventListener('load', () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            const result = JSON.parse(xhr.responseText);
            showStatus(`Upload successful! ${result.filesUploaded} file(s) uploaded. ID: ${result.runId}`, 'success');
            console.log('Upload result:', result);
            
            // Reset form
            resetForm();
          } else {
            const error = JSON.parse(xhr.responseText);
            showStatus(`Upload error: ${error.error || 'Unknown error'}`, 'error');
          }
        });

        // Error handling
        xhr.addEventListener('error', () => {
          showStatus('Connection error during upload', 'error');
        });

        // Send request
        xhr.open('POST', config.endpoint);
        
        // Add auth header if token exists
        const token = localStorage.getItem('token');
        if (token) {
          xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        }
        
        xhr.send(formData);

      } catch (error) {
        console.error('Upload error:', error);
        showStatus(`Upload error: ${error.message}`, 'error');
      } finally {
        currentUpload.isUploading = false;
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = `<span class="material-symbols-rounded">upload</span> Upload ${currentUpload.selectedPipeline.toUpperCase()}`;
        
        setTimeout(() => {
          if (!currentUpload.isUploading) {
            showProgress(false);
            updateProgress(0);
          }
        }, 2000);
      }
    }

    // Helper functions
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showProgress(show) {
      const progressDiv = document.getElementById('uploadProgress');
      if (progressDiv) {
        progressDiv.style.display = show ? 'block' : 'none';
      }
    }

    function updateProgress(percent) {
      const progressBar = document.querySelector('.progress-bar');
      const progressText = document.querySelector('.progress-text');
      
      if (progressBar) {
        progressBar.style.width = `${percent}%`;
      }
      if (progressText) {
        progressText.textContent = `${Math.round(percent)}%`;
      }
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('uploadStatus');
      if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.className = `upload-status ${type}`;
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
          setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'upload-status';
          }, 5000);
        }
      }
    }

    // Initialize
    analysis_select.addEventListener("change", handlePipelineSelection);
    fileInput.addEventListener("change", handleFileSelection);
    uploadForm.addEventListener("submit", handleUpload);
    
    // Initialize drag and drop
    initializeDragAndDrop();

  </script>
</body>
</html>