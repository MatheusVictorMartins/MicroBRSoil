<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Test Page - MicroBRSoil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .upload-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .upload-status {
            margin: 1rem 0;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .upload-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .upload-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .upload-status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background-color: #e9ecef;
            border-radius: 0.375rem;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container upload-container">
        <h1>MicroBRSoil Upload Test</h1>
        <p class="text-muted">Test page for the new upload endpoints</p>
        
        <div class="card">
            <div class="card-header">
                <h5>Pipeline Upload Test</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="pipelineSelect" class="form-label">Select Pipeline Type</label>
                    <select id="pipelineSelect" class="form-select">
                        <option value="">Choose pipeline...</option>
                        <option value="illumina">Illumina</option>
                        <option value="iontorrent">IonTorrent</option>
                        <option value="its">ITS</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="fileInput" class="form-label">FASTQ File</label>
                    <input type="file" id="fileInput" class="form-control" accept=".fastq,.fq,.fastq.gz,.fq.gz">
                    <small class="form-text text-muted">Supported formats: .fastq, .fq, .fastq.gz, .fq.gz</small>
                </div>
                
                <button id="uploadBtn" class="btn btn-primary" disabled>Upload</button>
                
                <div id="uploadStatus" class="upload-status" style="display: none;"></div>
                
                <div id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <small id="progressText" class="text-muted">0%</small>
                </div>
                
                <div id="uploadResult" class="mt-3" style="display: none;">
                    <h6>Upload Result:</h6>
                    <pre id="resultJson" class="bg-light p-2 rounded"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const pipelineSelect = document.getElementById('pipelineSelect');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadResult = document.getElementById('uploadResult');
        const resultJson = document.getElementById('resultJson');

        // Enable upload button when both pipeline and file are selected
        function checkCanUpload() {
            uploadBtn.disabled = !(pipelineSelect.value && fileInput.files[0]);
        }

        pipelineSelect.addEventListener('change', checkCanUpload);
        fileInput.addEventListener('change', checkCanUpload);

        function showStatus(message, type = 'info') {
            uploadStatus.style.display = 'block';
            uploadStatus.className = `upload-status ${type}`;
            uploadStatus.textContent = message;
        }

        function hideStatus() {
            uploadStatus.style.display = 'none';
        }

        function showProgress() {
            uploadProgress.style.display = 'block';
        }

        function hideProgress() {
            uploadProgress.style.display = 'none';
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
        }

        function updateProgress(percent) {
            const roundedPercent = Math.round(percent);
            progressFill.style.width = `${roundedPercent}%`;
            progressFill.textContent = `${roundedPercent}%`;
            progressText.textContent = `${roundedPercent}%`;
        }

        function showResult(result) {
            uploadResult.style.display = 'block';
            resultJson.textContent = JSON.stringify(result, null, 2);
        }

        function hideResult() {
            uploadResult.style.display = 'none';
        }

        async function uploadFile() {
            const pipelineType = pipelineSelect.value;
            const file = fileInput.files[0];

            if (!pipelineType || !file) {
                showStatus('Please select both pipeline type and file', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('fastq', file);

            const endpoint = `${window.location.origin}/api/upload/${pipelineType}`;

            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';
                hideStatus();
                hideResult();
                showProgress();

                showStatus(`Uploading ${file.name} to ${pipelineType} pipeline...`, 'info');

                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    
                    xhr.upload.addEventListener('progress', (event) => {
                        if (event.lengthComputable) {
                            const percentComplete = (event.loaded / event.total) * 100;
                            updateProgress(percentComplete);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (err) {
                                reject(new Error('Invalid response format'));
                            }
                        } else {
                            try {
                                const errorResponse = JSON.parse(xhr.responseText);
                                reject(new Error(errorResponse.error || `HTTP ${xhr.status}`));
                            } catch (err) {
                                reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                            }
                        }
                    });

                    xhr.addEventListener('error', () => {
                        reject(new Error('Network error occurred'));
                    });

                    xhr.open('POST', endpoint);
                    xhr.send(formData);
                });

                hideProgress();
                showStatus(`Upload successful! Run ID: ${result.runId}`, 'success');
                showResult(result);

            } catch (error) {
                console.error('Upload error:', error);
                hideProgress();
                showStatus(`Upload failed: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
                checkCanUpload();
            }
        }

        uploadBtn.addEventListener('click', uploadFile);
    </script>
</body>
</html>
